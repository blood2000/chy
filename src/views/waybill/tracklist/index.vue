
<template>
  <div class="app-container">
    <el-form
      v-show="showSearch"
      ref="queryForm"
      :model="queryParams"
      :inline="true"
      label-width="130px"
    >
      <el-form-item
        label="下单客户"
        prop="orderClient"
      >
        <el-input
          v-model="queryParams.orderClient"
          placeholder="请输入下单客户"
          clearable
          size="small"
          style="width: 240px"
          @keyup.enter.native="handleQuery"
        />
      </el-form-item>
      <el-form-item
        label="发货企业"
        prop="deliveryCompany"
      >
        <el-input
          v-model="queryParams.deliveryCompany"
          placeholder="请输入发货企业"
          clearable
          size="small"
          style="width: 240px"
          @keyup.enter.native="handleQuery"
        />
      </el-form-item>
      <el-form-item
        label="装货信息"
        prop="loadInfo"
      >
        <el-input
          v-model="queryParams.loadInfo"
          placeholder="请输入装货信息"
          clearable
          size="small"
          style="width: 240px"
          @keyup.enter.native="handleQuery"
        />
      </el-form-item>
      <el-form-item
        label="收货信息"
        prop="receivedInfo"
      >
        <el-input
          v-model="queryParams.receivedInfo"
          placeholder="请输入收货信息"
          clearable
          size="small"
          style="width: 240px"
          @keyup.enter.native="handleQuery"
        />
      </el-form-item>
      <el-form-item
        label="货源单号"
        prop="mainOrderNumber"
      >
        <el-input
          v-model="queryParams.mainOrderNumber"
          placeholder="请输入货源单号"
          clearable
          size="small"
          style="width: 240px"
          @keyup.enter.native="handleQuery"
        />
      </el-form-item>
      <el-form-item
        label="接单日期"
        prop="receiveTime"
      >
        <el-date-picker
          v-model="receiveTime"
          type="daterange"
          range-separator="-"
          start-placeholder="开始日期"
          end-placeholder="结束日期"
          style="width: 240px"
          @change="datechoose"
        />
      </el-form-item>
      <el-form-item
        label="车牌号"
        prop="licenseNumber"
      >
        <el-input
          v-model="queryParams.licenseNumber"
          placeholder="请输入车牌号"
          clearable
          size="small"
          style="width: 240px"
          @keyup.enter.native="handleQuery"
        />
      </el-form-item>
      <el-form-item
        label="司机姓名"
        prop="driverName"
      >
        <el-input
          v-model="queryParams.driverName"
          placeholder="请输入司机姓名"
          clearable
          size="small"
          style="width: 240px"
          @keyup.enter.native="handleQuery"
        />
      </el-form-item>
      <el-form-item
        label="司机电话"
        prop="driverPhone"
      >
        <el-input
          v-model="queryParams.driverPhone"
          placeholder="请输入司机电话"
          clearable
          size="small"
          style="width: 240px"
          @keyup.enter.native="handleQuery"
        />
      </el-form-item>
      <el-form-item
        label="运输单号"
        prop="waybillNo"
      >
        <el-input
          v-model="queryParams.waybillNo"
          placeholder="请输入运输单号"
          clearable
          size="small"
          style="width: 240px"
          @keyup.enter.native="handleQuery"
        />
      </el-form-item>


      <el-form-item>
        <el-button
          type="cyan"
          icon="el-icon-search"
          size="mini"
          @click="handleQuery"
        >
          搜索
        </el-button>
        <el-button
          icon="el-icon-refresh"
          size="mini"
          @click="resetQuery"
        >
          重置
        </el-button>
      </el-form-item>
    </el-form>

    <el-row
      :gutter="10"
      class="mb8"
    >
      <!-- <el-col :span="1.5">
        <el-button
          type="danger"
          icon="el-icon-delete"
          size="mini"
          @click="handleDelete"
        >批量删除</el-button>
      </el-col> -->
      <el-col :span="1.5" class="fr">
        <tablec-cascader v-model="tableColumnsConfig" />
      </el-col>
      <right-toolbar
        :show-search.sync="showSearch"
        @queryTable="getList"
      />
    </el-row>

    <el-tabs v-model="activeName" @tab-click="handleClick">
      <el-tab-pane label="待运输" name="1" />
      <el-tab-pane label="运输中" name="2" />
      <el-tab-pane label="已卸货" name="3" />
    </el-tabs>

    <RefactorTable :loading="loading" :data="tracklist" :table-columns-config="tableColumnsConfig"><!-- @selection-change="handleSelectionChange" -->
      <template #cancelStatus="{row}">
        <span>{{ selectDictLabel(cancelStatusOptions, row.cancelStatus) }}</span>
      </template>
      <!-- <template #goodsBigType="{row}">
        <span>{{ selectDictLabel(commodityCategoryCodeOptions, row.goodsBigType) }}</span>
      </template> -->

      <template #edit="{row}">
        <el-button
          v-if="activeName == '1'"
          v-hasPermi="['system:menu:edit']"
          size="mini"
          type="text"
          icon="el-icon-truck"
          @click="handleTableBtn(row, 1)"
        >车辆装货</el-button>
        <el-button
          v-if="activeName == '2'"
          v-hasPermi="['system:menu:edit']"
          size="mini"
          type="text"
          icon="el-icon-takeaway-box"
          @click="handleTableBtn(row, 2)"
        >车辆卸货</el-button>
        <el-button
          v-if="activeName == '1'"
          v-hasPermi="['system:menu:edit']"
          size="mini"
          type="text"
          icon="el-icon-circle-close"
          @click="handleTableBtn(row, 3)"
        >取消订单</el-button>
        <el-button
          v-if="activeName != '1'"
          v-hasPermi="['system:menu:edit']"
          size="mini"
          type="text"
          icon="el-icon-notebook-1"
          @click="handleTableBtn(row, 4)"
        >补装货凭证</el-button>
        <el-button
          v-if="activeName == '3'"
          v-hasPermi="['system:menu:edit']"
          size="mini"
          type="text"
          icon="el-icon-notebook-2"
          @click="handleTableBtn(row, 5)"
        >补卸货凭证</el-button>
        <el-button
          v-if="activeName != '1'"
          v-hasPermi="['system:menu:edit']"
          size="mini"
          type="text"
          icon="el-icon-aim"
          @click="handleTableBtn(row, 6)"
        >车辆跟踪</el-button>
        <el-button
          v-hasPermi="['system:menu:edit']"
          size="mini"
          type="text"
          icon="el-icon-location-outline"
          @click="handleTableBtn(row, 7)"
        >定位</el-button>
        <el-button
          v-hasPermi="['system:menu:edit']"
          size="mini"
          type="text"
          icon="el-icon-edit-outline"
          @click="handleTableBtn(row, 8)"
        >投诉</el-button>
        <el-button
          v-if="activeName == '3'"
          v-hasPermi="['system:menu:edit']"
          size="mini"
          type="text"
          icon="el-icon-chat-dot-square"
          @click="handleTableBtn(row, 9)"
        >评价</el-button>
      </template>
    </RefactorTable>

    <pagination
      v-show="total>0"
      :total="total"
      :page.sync="queryParams.pageNum"
      :limit.sync="queryParams.pageSize"
      @pagination="getList"
    />

    <!-- 车辆装货 / 补装货凭证 -->
    <dialog-a ref="DialogA" :open.sync="dialoga" :title="title" :disable="formDisable" @refresh="getList" />
    <!-- 车辆卸货 / 补卸货凭证 -->
    <dialog-c ref="DialogC" :open.sync="dialogc" :title="title" :disable="formDisable" @refresh="getList" />
    <!-- 投诉 -->
    <dialog-b ref="DialogB" :open.sync="dialogb" :title="title" @refresh="getList" />
    <!-- 取消订单 -->
    <cancel-dialog ref="CancelDialog" :open.sync="canceldialog" :title="title" @refresh="getList" />
    <!-- 评价 -->
    <rate-dialog ref="RateDialog" :open.sync="ratedialog" :title="title" @refresh="getList" />
    <!-- 车辆跟踪 -->
    <track-dialog ref="TrackDialog" :open.sync="trackdialog" :title="title" @refresh="getList" />
    <!-- 定位 -->
    <location-dialog ref="LocationDialog" :open.sync="locationdialog" :title="title" @refresh="getList" />

    <!-- <el-dialog :title="title" :visible.sync="visible" :width="dialogWidth" append-to-body>
      <div>{{ activeName }}</div>
    </el-dialog> -->

  </div>
</template>

<script>
// import tableColumnsConfig from './data/tracklist-index';
import { trackList, trackListApi } from '@/api/waybill/tracklist';
// 车辆装货弹窗
import DialogA from './component/DialogA';
// 投诉弹窗
import DialogB from './component/DialogB';
// 车辆卸货弹窗
import DialogC from './component/DialogC';
// 取消订单弹窗
import CancelDialog from './component/cancelDialog';
// 评价弹窗
import RateDialog from './component/rateDialog';
// 车辆跟踪弹窗
import TrackDialog from './component/trackDialog';
// 定位弹窗
import LocationDialog from './component/locationDialog';

export default {
  'name': 'Tracklist',
  components: { DialogA, DialogB, DialogC, CancelDialog, RateDialog, TrackDialog, LocationDialog },
  data() {
    return {
      tableColumnsConfig: [],
      activeName: '1',

      // 遮罩层
      'loading': false,
      // 选中数组
      //   'ids': [],
      // 显示搜索条件
      'showSearch': true,
      // 总条数
      'total': 0,
      // 表格数据
      'tracklist': [],

      // 查询参数
      'queryParams': {
        'pageNum': 1,
        'pageSize': 10,
        'orderClient': undefined,
        'deliveryCompany': undefined,
        'loadInfo': undefined,
        'receivedInfo': undefined,
        'mainOrderNumber': undefined,
        'orderEndTime': undefined,
        'orderStartTime': undefined,
        'licenseNumber': undefined,
        'driverName': undefined,
        'driverPhone': undefined,
        'waybillNo': undefined,
        'statusList': ['1']
      },
      receiveTime: [],
      // 弹框 内容
      visible: false,

      dialoga: false,
      dialogb: false,
      dialogc: false,
      canceldialog: false,
      ratedialog: false,
      trackdialog: false,
      locationdialog: false,
      title: '',
      dialogWidth: '800px',
      // 表单是否禁用
      formDisable: false,
      // 商品类别编码字典
      commodityCategoryCodeOptions: [],
      // 大类字典类型
      commodityCategory: {
        'dictPid': '0',
        'dictType': 'goodsType'
      },
      // 取消状态
      cancelStatusOptions: [
        { 'dictLabel': '正常', 'dictValue': '0' },
        { 'dictLabel': '司机撤单申请', 'dictValue': '1' },
        { 'dictLabel': '货主同意撤销 ', 'dictValue': '2' },
        { 'dictLabel': '货主拒绝撤销 ', 'dictValue': '3' }
      ]
    //   // <!-- isPay	支付给司机运费状态 0-未支付 1-已支付 -->
    //   isPayOptions: [
    //     { 'dictLabel': '未支付', 'dictValue': '0' },
    //     { 'dictLabel': '已支付', 'dictValue': '1' }
    //   ]
    };
  },
  computed: {
    lcokey() {
      return this.$route.name + this.activeName;
    }
  },
  created() {
    // this['tableColumnsConfig' + this.activeName] = this.getLocalStorage(this.lcokey) || this.tableColumnsConfig;
    this.tableHeaderConfig(this.tableColumnsConfig, trackListApi, {
      prop: 'edit',
      isShow: true,
      label: '操作',
      width: 280,
      fixed: 'right'
    });
    this.getList();
    this.listByDict(this.commodityCategory).then(response => {
      this.commodityCategoryCodeOptions = response.data;
    });
  },
  'methods': {
    datechoose(date) {
      this.queryParams.orderEndTime = this.parseTime(date[0], '{y}-{m}-{d}');
      this.queryParams.orderStartTime = this.parseTime(date[1], '{y}-{m}-{d}');
    },
    /** handleClick */
    handleClick(tab) {
      // this['tableColumnsConfig' + this.activeName] = this.getLocalStorage(this.lcokey) || this.tableColumnsConfig;
      this.queryParams.statusList[0] = tab.name;
      this.queryParams.pageNum = 1;
      // console.log(this.queryParams);
      this.getList();
    },

    /** 查询【请填写功能名称】列表 */
    getList() {
      // console.log(this.queryParams);
      this.loading = true;
      trackList(this.queryParams).then(response => {
        this.tracklist = response.rows;
        this.total = response.total;
        this.loading = false;
      });
    },
    /** 搜索按钮操作 */
    handleQuery() {
      this.queryParams.pageNum = 1;
      this.getList();
    },
    /** 重置按钮操作 */
    resetQuery() {
      this.resetForm('queryForm');
      this.handleQuery();
    },
    handleDelete() {
      this.$refs.DialogB.reset();
      this.dialogb = true;
      this.title = '投诉';
    },
    handleTableBtn(row, index) {
      // console.log(row, index);

      this.visible = true;
      switch (index) {
        case 1:
          if (row.cancelStatus === 1) {
            this.msgError('司机撤单申请中，无法操作装货！');
          } else if (row.cancelStatus === 2) {
            this.msgError('货主已同意撤单，无法操作装货！');
          } else {
            // this.$refs.DialogA.reset();
            this.dialoga = true;
            this.title = '车辆装货';
            this.formDisable = false;
            this.$refs.DialogA.setForm(row);
            // this.$refs.DialogA.getAddress(row);
          }
          break;
        case 2:
          // this.$refs.DialogC.reset();
          this.dialogc = true;
          this.title = '车辆卸货';
          this.formDisable = false;
          this.$refs.DialogC.setForm(row);
          // this.$refs.DialogC.getAddress(row);
          break;
        case 3:
          if (row.cancelStatus === 1) {
            this.msgError('司机撤单申请中，无法再次取消订单！');
          } else if (row.cancelStatus === 2) {
            this.msgError('货主已同意撤单，无法取消订单！');
          } else {
            this.$refs.CancelDialog.reset();
            this.canceldialog = true;
            this.title = '取消运单';
            this.$refs.CancelDialog.setForm(row);
          }
          break;
        case 4:
          // this.$refs.DialogA.reset();
          this.dialoga = true;
          this.formDisable = true;
          this.title = '补装货凭证';
          this.$refs.DialogA.setForm(row);
          // this.$refs.DialogA.getAddress(row);
          break;
        case 5:
          // this.$refs.DialogC.reset();
          this.dialogc = true;
          this.formDisable = true;
          this.title = '补卸货凭证';
          this.$refs.DialogC.setForm(row);
          // this.$refs.DialogC.getAddress(row);
          break;
        case 6:
          this.title = '车辆跟踪';
          this.trackdialog = true;
          this.$refs.TrackDialog.setForm(row);
          break;
        case 7:
          this.title = '定位';
          this.locationdialog = true;
          this.$refs.LocationDialog.setForm(row);
          break;
        case 8:
          this.$refs.DialogB.reset();
          this.dialogb = true;
          this.title = '投诉';
          this.$refs.DialogB.setForm(row);
          break;
        case 9:
          this.$refs.RateDialog.reset();
          this.ratedialog = true;
          this.title = '评价';
          this.$refs.RateDialog.setForm(row);
          break;
        default:
          break;
      }
    }
  }
};
</script>
