<template>
  <el-dialog
    v-loading
    :title="`发卡人: ${ userInfo.issuing_name || ''} 【承运司机: ${userInfo.user_name ||''}】 【发卡时间: ${ parseTime(userInfo.issuing_time - 0) || ''}】 【卡批次号: ${ userInfo.issuing_pc || ''}】 ` "
    :visible="visible"
    width="80%"
    append-to-body
    :close-on-click-modal="false"
    @close="handlerClose"
  >
    <div v-show="false" class="mb20" style="padding: 20px;">
      <!-- <el-button type="primary" @click="handler('cancellation')">注销卡片(清空使用者信息)</el-button> -->
      <el-button type="primary" @click="handler('issuingCard')">issuingCard</el-button>
      <!-- <el-button type="primary" @click="handler('readUserinfo')">读取用户信息</el-button> -->
      <!-- <el-button type="primary" @click="handler('readData')">读取数据</el-button> -->
      <el-button type="primary" @click="handler('writeData')">writeData</el-button>
      <el-button type="primary" @click="handler('getCardInfo')">卡注册给卡加上标识</el-button>
    </div>

    <RefactorTable
      :loading="loading"
      :data="list"
      :table-columns-config="[
        {
          prop: 'driverName',
          isShow: true,
          tooltip: true,
          label: '驾驶员姓名'
        },
        {
          prop: 'driverPhone',
          isShow: true,
          tooltip: true,
          label: '联系手机号'
        },
        {
          prop: 'licenseNumber',
          isShow: true,
          tooltip: true,
          label: '车牌号'
        },
        {
          prop: 'projectName',
          isShow: true,
          label: '项目(装货地)'
        },
        {
          prop: 'mudtail',
          isShow: true,
          label: '泥尾'
        },
        {
          prop: 'fillTimeDate',
          isShow: true,
          label: '入场时间'
        },
        {
          prop: 'signTimeDate',
          isShow: true,
          label: '出场时间'
        },
        {
          prop: 'orderId',
          isShow: true,
          label: '货源编号'
        },
        {
          prop: 'waybillNo',
          isShow: true,
          label: '运单编号'
        },
        {
          prop: 'serialNumber',
          isShow: true,
          label: '渣土场'
        },
        {
          prop: 'writeOffStatus',
          isShow: true,
          label: '异常标记'
        },
        {
          prop: 'writeOffRemark',
          isShow: true,
          label: '异常备注',
          width: 200,
        },
      ]"
    >
      <template #writeOffStatus="{row}">
        <el-switch
          v-model="row.writeOffStatus"
          :disabled="row.$_disable"
          active-color="#13ce66"
          inactive-color="#ff4949"
        />
      </template>
      <template #writeOffRemark="{row}">
        <span v-if="row.writeOffStatus"><i class="el-icon-check" /></span>
        <el-input v-else v-model="row.writeOffRemark" :disabled="row.$_disable" placeholder="请输入异常备注" />
      </template>

      <!-- <template v-if="!isError" #status="{row}">
        <span v-if="row.status === 0"><i class="el-icon-check" /></span>
        <el-button v-else size="mini" type="danger" plain @click="absenceOpen(row)">不存在</el-button>
      </template> -->
    </RefactorTable>


    <div slot="footer" class="dialog-footer ly-flex-pack-center">
      <el-button type="primary" :disabled="loading || !list.length || isUserInfo || isWart" @click="submitForm">保存并清空</el-button>
      <!-- <el-button type="primary" :disabled="loading || !list.length || isUserInfo || isError || isWart" @click="submitForm">保存并清空</el-button> -->
    </div>
  </el-dialog>
</template>

<script>
import CardReader, { USERINFO, versionMark } from '@/libs/ICCard/CardReader';
import { checkList, check } from '@/api/settlement/adjustDregs';
const { action, fn } = CardReader;

export default {
  name: 'NuclearCard',
  props: {
    open: Boolean
  },
  data() {
    return {
      loading: false,
      isWart: false,
      userInfo: {},
      list: [],
      IClist: [],
      delData: [], // 保存删除的数据
      meter: null,
      carId: undefined,
      errorCount: 0
    };
  },
  computed: {
    visible: {
      get() {
        if (this.open) {
          this._minit();
        } else {
          this._close();
        }
        return this.open;
      },
      set(v) {
        this.$emit('update:open', v);
      }
    },

    isUserInfo() {
      return JSON.stringify(this.userInfo) === '{}';
    }
  },

  methods: {
    init() {},
    // 连接` 读卡(卡id + 当前卡信息 + 卡存储的运单)
    _minit() {
      CardReader.fn.connect(async() => {
        this.loading = true;
        const ret = await action.readUserInfoAndreadData();

        // console.log(ret, '数据');

        // 失败
        if (!ret.success && !ret.code) {
          this.errorCount++;
          this._reqerror();
          return;
        }

        // 读取文件失败
        if (ret.code === '6A82') {
          if (ret.userInfo) {
            this.userInfo = ret.userInfo;
          }
          this.msgWarning(ret.msg);
          return;
        }

        // 其他失败
        if (ret.code !== '9000' || (!ret.success && ret.code === '9000')) {
          this.msgError(ret.msg);
          return;
        }


        // 成功 的数据
        this.userInfo = ret.userInfo;
        this.userInfo.issuing_pc = this.userInfo.issuing_pc || Date.now() + '456';
        this.IClist = ret.dataList;
        this.meter = ret.meter;
        this.carId = ret.GetCardNo.data;

        console.log([this.userInfo], '----------持卡者信息');
        console.log([this.IClist], '----------当前卡数据');
        console.log([this.meter], '----------卡版本');
        console.log([this.carId], '----------ka标识');
        // this.setLocalStorage(this.userInfo.user_code, { [this.userInfo]: this.IClist, meter: this.meter }); // 本地存储

        // 后端交互
        this.initData();
      }, () => {
        this.loading = false;
        this.$emit('update:open', false);
      });
    },

    // 请求
    async initData() {
      // 参数
      const que = {
        icList: this.IClist.map(e => {
          return {
            ...e,
            fillTimeDate: e.fillTime,
            signTimeDate: e.signTime,
            other: undefined
          };
        }),
        icCode: this.carId
        // driverCode: undefined // this.userInfo.user_code //	用户CODE
      };

      try {
        const res = await checkList(que);

        // 处理数据
        this.list = res.data.map(e => {
          console.log(e);
          return {
            ...e,
            driverName: e.batchWayBillBalanceInfoVo.driverName || '-',
            projectName: e.batchWayBillBalanceInfoVo.projectName || '-',
            serialNumber: e.batchWayBillBalanceInfoVo.ztcName || e.serialNumber,
            mudtail: e.batchWayBillBalanceInfoVo.unloadAddress || '-',
            writeOffStatus: e.writeOffStatus === 0,
            $_disable: e.writeOffStatus === -1,
            fillTimeDate: this.parseTime(e.fillTime - 0),
            signTimeDate: this.parseTime(e.signTime - 0)
          };
        });

        // 排序
        this.list.sort((m, n) => {
          if (m.writeOffStatus > n.writeOffStatus) return -1;
        });
        this.loading = false;
      } catch (error) {
        this.loading = false;
      }
    },

    /**
      // absenceOpen(row) {
      //   this.$confirm('运单不存在', `运单: ${row.waybillId}`, {
      //     confirmButtonText: '转为正常单',
      //     cancelButtonText: '删除该条记录',
      //     distinguishCancelAndClose: true,
      //     type: 'warning',
      //     center: true
      //   }).then(() => {
      //     // console.log('转为正常单- 接口欠着');
      //     row.status = 0;
      //   }).catch((action) => {
      //     if (action === 'cancel') {
      //      { waybillId: row.waybillId - 0 }).then(res => {
      //         this.msgSuccess('删除该条记录成功');
      //         this.list = this.list.filter(e => e.waybillId !== row.waybillId);
      //         this.delData.push(row.waybillId);
      //         // console.log('当前删除的数据是', this.delData);
      //       });
      //     }
      //   });
      // },
    */
    /** 核销 */
    async submitForm() {
      // 判断异常的数据 条件 writeOffStatus 为false的时候是异常
      const filterArr = this.list.filter(e => {
        return !e.writeOffStatus;
      });

      // 数据有异常提示
      if (filterArr.length > 0) {
        this.$confirm(`运单存在${filterArr.length} 条异常单, 确定继续将把数据写回卡中, 并核销正常单`, '数据存在异常', {
          confirmButtonText: '确定',
          cancelButtonText: '取消',
          type: 'warning'
        }).then(async() => {
          await this.handlerCheck();
          // 写卡
          this.errorHexiaoCheck(filterArr);
        }).catch(() => {
          // 测试数据 ----------------------------------------------------------------------------------------
          // console.log(this.list);
          // this.$emit('listData', (this.list.filter(e => e.writeOffStatus)).map(e => {
          //   e.batchWayBillBalanceInfoVo.icStatus = '1';
          //   e.icStatus = '1';
          //   e.$_userInfo = this.userInfo;
          //   return e;
          // }));

          // const queArr = (this.list.filter(ee => !ee.$_disable)).map(e => {
          //   return {
          //     card16no: this.carId,
          //     cardBatchNo: this.userInfo.issuing_pc,
          //     waybillNo: e.waybillNo,
          //     writeOffStatus: e.writeOffStatus ? 0 : 1,
          //     writeOffRemark: e.writeOffStatus ? '' : e.writeOffRemark
          //   };
          // });

          // console.log(queArr);
        });
      } else {
        this.$confirm(`确定立即核销`, '数据正常', {
          confirmButtonText: '确定',
          cancelButtonText: '取消',
          type: 'warning'
        }).then(async() => {
          await this.handlerCheck();
          // 无异常做核销动作
          const res = await action.cancellation();
          if (res.code === 200) {
            this.loading = false;
            this.msgSuccess('核销成功');
            this.handlerClose();
          }
        });
      }
    },

    // 核销请求
    async handlerCheck() {
      this.loading = true;

      // 过滤出异常$_disable 为true的数据

      // console.log((this.list.filter(ee => !ee.$_disable)));
      const queArr = (this.list.filter(ee => !ee.$_disable)).map(e => {
        return {
          card16no: this.carId,
          cardBatchNo: this.userInfo.issuing_pc,
          waybillNo: e.waybillNo,
          waybillCode: e.batchWayBillBalanceInfoVo.wayBillCode,
          writeOffStatus: e.writeOffStatus ? 0 : 1,
          writeOffRemark: e.writeOffStatus ? '' : e.writeOffRemark
        };
      });

      // 数据发送给父组件

      this.$emit('listData', (this.list.filter(e => e.writeOffStatus)).map(e => {
        e.batchWayBillBalanceInfoVo.icStatus = '1';
        e.icStatus = '1';
        e.$_userInfo = this.userInfo;
        return e;
      }));

      return await check(queArr);
    },


    // 异常要做写回卡的操作 filterArr 是异常的数据
    async errorHexiaoCheck(filterArr) {
      // 走发卡-写卡
      if (!this.userInfo) return;
      // console.log(this.userInfo);

      await action.issuingCard(this.userInfo);
      // 写卡
      // 定义 版本标识
      const meter = this.meter ? this.meter.join('|') + '|' : versionMark;

      // const arr = [];

      // 通过时间来
      const arr = [];
      filterArr.forEach(async(e, index) => {
        this['time' + index] = setTimeout(() => {
          action.writeData(fn.setData(meter, e)).then(res => {
            clearTimeout(this['time' + index]);
            arr.push(true);
            if (arr.length === filterArr.length && arr.every(e => e)) {
              this.loading = false;
              this.msgSuccess('核销成功');
              this.handlerClose();
            }
          });
        }, (index + 1) * 500);
      });


      // for (let index = 0; index < filterArr.length; index++) {
      //   const e = filterArr[index];

      //   const res = await action.writeData(fn.setData(meter, e));
      //   arr.push(true);
      //   if (arr.length === filterArr.length && arr.every(e => e)) {
      //     this.loading = false;

      //     this.msgSuccess(res.msg, '操作成功');
      //     this.handlerClose();
      //   } else {
      //     console.log(arr.length, '写了条数');
      //   }
      // }
    },

    // 关闭
    _close() {
      if (CardReader.socket) {
        CardReader.socket.onclose = function() {}; // disable onclose handler first
        CardReader.socket.close();
        CardReader.socket = null;
        this.userInfo = {};
        this.list = [];
        this.IClist = [];
      }
    },

    _reqerror() {
      const msg = this.errorCount > 0 ? '请重新开启应用程序' : '请将【数据IC卡】放至有效位置!';

      this.$confirm(msg, '不能读取到数据', {
        confirmButtonText: '知道了',
        type: 'warning',
        showCancelButton: false,
        center: true
      }).then(() => {
        this.$emit('update:open', false);
      }).catch(() => {
        this.$emit('update:open', false);
      });
    },

    // _returnWrite(userData, infoDataList) {
    //   this.loading = true;
    //   this.isWart = true;
    //   action.issuingCard({
    //     user_code: userData.user_code,
    //     user_telno: userData.user_telno,
    //     user_name: userData.user_name,
    //     issuing_code: userData.issuing_code,
    //     issuing_name: userData.issuing_name
    //   }).then(res => {
    //     // console.log(infoDataList);
    //     let meter = '1010|1|';
    //     if (this.meter) {
    //       meter = this.meter.join('|') + '|';
    //     }

    //     const arr = [];
    //     infoDataList.forEach(async(e, index) => {
    //       // 1010|1|30273;2977608;测试项目3;闽AQ8001;测试独立强;15859109001;1623177000000;1623177480000;;妈湾
    //       // '1010|1|30273;2977608;测试项目3;闽AQ8001;测试独立强;15859109001;1623177000000;1623177480000;;妈湾';
    //       this['time' + index] = setTimeout(() => {
    //         action.writeData(fn.setData(meter, e)).then(res => {
    //           // console.log('写入成功' + index);
    //           clearTimeout(this['time' + index]);
    //           arr.push(true);
    //           if (arr.length === infoDataList.length && arr.every(e => e)) {
    //             this.loading = false;
    //             this.isWart = false;
    //             this.msgSuccess(res.msg, '操作成功');
    //             this.delData = [];
    //             this.handlerClose();
    //           }
    //         });
    //       }, (index) * 1500);
    //     });
    //   });
    // },
    handlerClose() {
      // if (this.isWart) return;
      // if (this.delData.length > 0) {
      //   this.$confirm('删除数据要花费' + (this.list.length * 1500) / 1000 + '秒, 期间禁止移动卡片, 确定要删除' + this.delData.join(',') + '吗', '确定要从卡里面清除吗?', {
      //     confirmButtonText: '确定删除',
      //     cancelButtonText: '保留原记录',
      //     type: 'warning',
      //     center: true
      //   }).then(() => {
      //     this._returnWrite(this.userInfo, this.list);
      //     // console.log(this.list);
      //     // console.log(this.IClist);
      //   }).catch(() => {
      //     this.$emit('update:open', false);
      //   });
      //   this.delData = [];

      //   return;
      // }

      this.$emit('update:open', false);
    },

    /** 卡的操作 */
    async handler(key) {
      const mobj = {};
      const arr = '张三;18415451845;120;16612345678;17812345678;陈大帅;1621648441990;1621648441990129';
      // const res = '';
      switch (key) {
        case 'getCardInfo':
          action.getCardInfo().then(res => {
            // console.log(res);
          });
          break;
        case 'cancellation':
          // 注销卡片
          action.cancellation().then(res => {
            // console.log(res);
          });
          break;
        case 'issuingCard':
          // 发卡
          USERINFO.forEach((e, index) => {
            mobj[e] = (arr.split(';'))[index];
          });

          action.issuingCard(mobj).then(res => {
            this.msgSuccess(res.msg);
          });
          break;
        case 'readUserinfo':
          // 读取用户信息
          action.readUserInfo().then(res => {
            // console.log(res);
          });

          break;
        case 'readData':
          break;
        case 'readUserInfoAndreadData':
          // 读取数据e
          action.readUserInfoAndreadData();
          break;
        case 'writeData':
          // 写数据

          // res = await action.writeData('1010|1|30528;2106231554010424;616测试项目1;闽AQ8002;测试独立加强;15859109002;1624068000000;1624068000000;31;616测试1—石渣土');
          // // console.log(res);
          // res = await action.writeData('1010|1|30528;2106231554010424;616测试项目1;闽AQ8002;测试独立加强;15859109002;1624068000000;1624068000000;31;616测试1—石渣土');
          // // console.log(res);
          // res = await action.writeData('1010|1|30528;2106231534477638;616测试项目1;闽AQ8001;测试独立强;15859109001;1624068000000;1624068000000;31;616测试1—石渣土'); // ok数据
          // console.log(res);
          // res = await action.writeData('1010|1|30528;2106191000275189;616测试项目1;闽AQ8002;测试独立加强;15859109002;1624068000000;1624068000000;31;616测试1—石渣土');
          // console.log(res);
          // res = await action.writeData('1010|1|30528;2106191000275110;616测试项目1;闽AQ8002;测试独立加强;15859109002;1624068000000;1624068000000;31;616测试1—石渣土');
          // console.log(res);
          // res = await action.writeData('1010|1|30528;2106191000275111;616测试项目1;闽AQ8002;测试独立加强;15859109002;1624068000000;1624068000000;31;616测试1—石渣土');
          // console.log(res);
          // res = await action.writeData('1010|1|30528;2106191000275112;616测试项目1;闽AQ8002;测试独立加强;15859109002;1624068000000;1624068000000;31;616测试1—石渣土');
          // console.log(res);
          // res = await action.writeData('1010|1|30528;2106191000275113;616测试项目1;闽AQ8002;测试独立加强;15859109002;1624068000000;1624068000000;31;616测试1—石渣土');
          // console.log(res);
          // res = await action.writeData('1010|1|30528;2106191000275114;616测试项目1;闽AQ8002;测试独立加强;15859109002;1624068000000;1624068000000;31;616测试1—石渣土');
          // console.log(res);

          break;
        default:
          break;
      }
    }
  }
};
</script>

<style>

</style>
